YUI.add("moodle-mod_quiz-autosave",function(e,t){M.mod_quiz=M.mod_quiz||{},M.mod_quiz.autosave={TINYMCE_DETECTION_DELAY:500,TINYMCE_DETECTION_REPEATS:20,WATCH_HIDDEN_DELAY:1e3,SELECTORS:{QUIZ_FORM:"#responseform",VALUE_CHANGE_ELEMENTS:"input, textarea",CHANGE_ELEMENTS:"input, select",HIDDEN_INPUTS:"input[type=hidden]"},AUTOSAVE_HANDLER:M.cfg.wwwroot+"/mod/quiz/autosave.ajax.php",delay:12e4,form:null,dirty:!1,delay_timer:null,save_transaction:null,editor_change_handler:null,hidden_field_values:{},init:function(t){this.form=e.one(this.SELECTORS.QUIZ_FORM);if(!this.form)return;this.delay=t*1e3,this.form.delegate("valuechange",this.value_changed,this.SELECTORS.VALUE_CHANGE_ELEMENTS,this),this.form.delegate("change",this.value_changed,this.SELECTORS.CHANGE_ELEMENTS,this),this.form.on("submit",this.stop_autosaving,this),this.init_tinymce(this.TINYMCE_DETECTION_REPEATS),this.save_hidden_field_values(),this.watch_hidden_fields(),this.restore_saved_data()},save_hidden_field_values:function(){this.form.all(this.SELECTORS.HIDDEN_INPUTS).each(function(e){var t=e.get("name");if(!t)return;this.hidden_field_values[t]=e.get("value")},this)},watch_hidden_fields:function(){this.detect_hidden_field_changes(),e.later(this.WATCH_HIDDEN_DELAY,this,this.watch_hidden_fields)},detect_hidden_field_changes:function(){this.form.all(this.SELECTORS.HIDDEN_INPUTS).each(function(e){var t=e.get("name"),n=e.get("value");if(!t)return;if(!(t in this.hidden_field_values)||n!==this.hidden_field_values[t])this.hidden_field_values[t]=n,this.value_changed({target:e})},this)},init_tinymce:function(t){if(typeof tinyMCE=="undefined"){t>0&&e.later(this.TINYMCE_DETECTION_DELAY,this,this.init_tinymce,[t-1]);return}this.editor_change_handler=e.bind(this.editor_changed,this),tinyMCE.onAddEditor.add(e.bind(this.init_tinymce_editor,this))},init_tinymce_editor:function(e,t){t.onChange.add(this.editor_change_handler),t.onRedo.add(this.editor_change_handler),t.onUndo.add(this.editor_change_handler),t.onKeyDown.add(this.editor_change_handler)},value_changed:function(e){if(e.target.get("name")==="thispage"||e.target.get("name")==="scrollpos"||e.target.get("name").match(/_:flagged$/))return;this.save_locally(e.target.get("name"),e.target.get("value"),e.target.get("type")),this.start_save_timer_if_necessary()},save_locally:function(t,n,r){var i,s,o,u,a,f;i=this.get_form_question_prefix_from_id(t),s=i+"_:sequencecheck",o=this.hidden_field_values[s],u=this.get_saved_question_data(i),u&&u.sequencecheck!==o&&(u=null);if(!u||!u.fields)u={sequencecheck:o,fields:{}};f=this.get_form_question_field_name_from_id(t);switch(r){case"checkbox":n=e.one('[id^="'+i+"_"+f+'"]').get("checked")?1:0;break;case"editor":f=f.substr(0,f.indexOf("_id"))}u.fields[f]=n,window.localStorage.setItem(i,e.JSON.stringify(u))},get_saved_question_data:function(t){var n,r;try{r=window.localStorage.getItem(t);if(!r)return n;n=e.JSON.parse(r)}catch(i){}return n},get_form_question_prefix_from_id:function(e){return e.substring(0,e.indexOf("_"))},get_form_question_field_name_from_id:function(e){return e.substring(e.indexOf("_")+1)},restore_saved_data:function(){var e,t,n,r;for(t in this.hidden_field_values){var i=t.indexOf("sequencecheck");if(t.indexOf("sequencecheck")<0)continue;n=this.hidden_field_values[t],e=this.get_form_question_prefix_from_id(t),r=this.get_saved_question_data(e);if(!r||!r.fields)continue;if(r.sequencecheck!==n)continue;r.autosave=this;for(var s in r.fields)var o='[name^="'+e+"_"+s+'"]',u=this.form.all(o).each(this.update_field_value_with_saved,r)}},update_field_value_with_saved:function(e){var t=this.autosave.get_form_question_field_name_from_id(e.get("name")),n=e.get("type"),r=this.fields[t];switch(e.get("type")){case"text":e.set("value",r);break;case"radio":if(e.get("value")!==r)return;e.set("checked","checked");break;case"textarea":e.set("value",r);break;case"checkbox":e.set("checked",r);break;case"select-one":var i=e.one('option[value="'+r+'"]');i&&i.set("selected",1)}},editor_changed:function(e){this.save_locally(e.id,e.getContent(),"editor"),this.start_save_timer_if_necessary()},start_save_timer_if_necessary:function(){this.dirty=!0;if(this.delay_timer||this.save_transaction)return;this.start_save_timer()},start_save_timer:function(){this.cancel_delay(),this.delay_timer=e.later(this.delay,this,this.save_changes)},cancel_delay:function(){this.delay_timer&&this.delay_timer!==!0&&this.delay_timer.cancel(),this.delay_timer=null},save_changes:function(){this.cancel_delay(),this.dirty=!1;if(this.is_time_nearly_over()){this.stop_autosaving();return}typeof tinyMCE!="undefined"&&tinyMCE.triggerSave(),this.save_transaction=e.io(this.AUTOSAVE_HANDLER,{method:"POST",form:{id:this.form},on:{complete:this.save_done},context:this})},save_done:function(){this.save_transaction=null,this.dirty&&this.start_save_timer()},is_time_nearly_over:function(){return M.mod_quiz.timer&&M.mod_quiz.timer.endtime&&(new Date).getTime()+2*this.delay>M.mod_quiz.timer.endtime},stop_autosaving:function(){this.cancel_delay(),this.delay_timer=!0,this.save_transaction&&this.save_transaction.abort()}}},"@VERSION@",{requires:["base","node","event","event-valuechange","node-event-delegate","io-form","json-parse","json-stringify"]});
